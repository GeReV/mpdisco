/*! mpdisco 2014-06-26 */
define(["mpdisco"],function(a){var b=a.module("Playlist",function(a,b,c,d,e,f){a.Collection=b.Collection.extend({socketEvents:{playlistinfo:"reset"}}),a.PlaylistItemView=d.ItemView.extend({tagName:"li",className:"playlist-item",template:"playlist_item",onDomRefresh:function(){this.$el.attr("data-songid",this.model.id)}}),a.PlaylistView=d.CompositeView.extend({template:"playlist",className:"playlist",ui:{playlist:"ul",url:"#url",remove:".remove",shuffle:".shuffle",repeat:".repeat"},model:b.state,collection:new a.Collection,itemView:a.PlaylistItemView,itemViewContainer:".list",collectionEvents:{reset:"render"},modelEvents:{change:"updatePlaylist"},events:{"keyup #url":"add","click .remove":"remove","dblclick li":"play","click li":"selectClick",drop:"drop","click .shuffle":"toggleShuffle","click .repeat":"toggleRepeat"},selectedSongs:[],initialize:function(){b.command("playlistinfo"),this.listenTo(b.state,"change:songid",this.updatePlaylist)},onRender:function(){this.pluginsInitialized=!1},onCompositeCollectionRendered:function(){var a=this;this.ui.playlist.droppable({hoverClass:"playlist-drop",scope:"media"}),this.ui.playlist.sortable({appendTo:this.$el,helper:function(){return document.createElement("ul")},placeholder:"playlist-item-placeholder",opacity:.8,start:function(b,c){c.item.hasClass("selected")||a.select(c.item);var d=c.item.parent().children(".selected").not(".ui-sortable-placeholder");d.size()||(d=c.item),c.helper.append(d.clone(!0).show()),d.hide(),c.item.data("multidrag",d)},stop:function(a,c){var d=c.item.data("multidrag"),f=d.index(c.item),g=this.ui.playlist;c.item.before(d.slice(0,f)),c.item.after(d.slice(f+1)),d.show(),commands=g.children().map(function(a,b){var c=e(b),d=c.data("songid");return{command:"moveid",args:[d,g.find('[data-songid="'+d+'"]').index()]}}).toArray(),b.commands(commands)}.bind(this)}),this.ui.playlist.disableSelection(),this.updatePlaylist(),e.each(this.selectedSongs,function(b,c){a.ui.playlist.find('[data-songid="'+c+'"]').addClass("selected")}),this.pluginsInitialized=!0},onShow:function(){e(document).on("keydown.playlist",this.handleKeyboard.bind(this))},onClose:function(){e(document).off("keydown.playlist")},updatePlaylist:function(a){a=a||this.model;var b=a.get("songid")||a.id;b?this.ui.playlist.find('[data-songid="'+b+'"]').addClass("current").siblings().removeClass("current"):this.ui.playlist.children().removeClass("current"),this.ui.shuffle.toggleClass("active","1"===a.get("random")),this.ui.repeat.toggleClass("active","1"===a.get("repeat")),this.ui.repeat.toggleClass("single","1"===a.get("single"))},add:function(a){var c=e.trim(this.ui.url.val());return 13===a.which&&c&&(b.command("add",c),this.ui.url.addClass("disabled loading")),!1},drop:function(a,c){var d=c.helper.data("model"),e=[];f.each(["artist","album","title"],function(a){var b;(b=d[a])&&(e.push(a),e.push(b))}),e.length&&b.command("findadd",e)},play:function(a){var c=a&&a.currentTarget?e(a.currentTarget):this.selectedItems.first();return b.network.command("playid",c.data("songid")),!1},remove:function(){var a=this.ui.playlist.find(".selected").map(function(a,b){return{command:"deleteid",args:[e(b).data("songid")]}}).toArray();return b.commands(a),!1},toggleShuffle:function(){var a=1&~b.state.get("random");return this.ui.shuffle.toggleClass("active",a),b.command("random",a),!1},toggleRepeat:function(){var a=+b.state.get("repeat"),c=+b.state.get("single");return a&&c?(this.ui.repeat.removeClass("active single"),b.commands([{command:"repeat",args:0},{command:"single",args:0}])):a?(this.ui.repeat.addClass("single"),b.command("single",1)):(this.ui.repeat.addClass("active"),b.command("repeat",1)),!1},selectClick:function(a){this.ui.url.trigger("blur"),this.select(a,e(a.currentTarget))},select:function(a,b){b||(b=a),a.currentTarget&&(b=e(a.currentTarget)),b.size()&&(a.ctrlKey||a.metaKey?this.selectToggle(b):a.shiftKey?this.selectRange(this.$(".selected").last(),b):b.hasClass("selected")||this.selectOne(b),this.scrollIntoView(b),this.setRemoveButton(),this.selectedSongs=this.$(".selected").map(function(a,b){return e(b).data("songid")}).toArray())},selectAll:function(){var a=this.$(".playlist-item");this.selectRange(a.first(),a.last()),this.setRemoveButton()},selectNone:function(){this.$(".selected").removeClass("selected"),this.setRemoveButton()},selectOne:function(a){a.addClass("selected").siblings().removeClass("selected"),this.setRemoveButton()},selectToggle:function(a){a.toggleClass("selected"),this.setRemoveButton()},selectRange:function(a,b){if(a||b){if(!a.size())return void this.selectOne(b);var c=a.index()>=b.index()?a.prevUntil(b):a.nextUntil(b);this.ui.playlist.children().removeClass("selected"),c.addBack().add(b).addClass("selected"),this.scrollIntoView(b),this.setRemoveButton()}},selectPrev:function(){var a;return this.selectedSongs&&(a=this.$(".selected").last().prev()),a||(a=this.ui.playlist.children().first()),a.size()||(a=this.ui.playlist.children().first()),this.select(a),!1},selectNext:function(){var a;return this.selectedSongs&&(a=this.$(".selected").last().next()),a||(a=this.ui.playlist.children().first()),a.size()||(a=this.ui.playlist.children().last()),this.select(a),!1},scrollIntoView:function(a){var b=this.ui.playlist.prop("scrollTop"),c=this.ui.playlist.height(),d=a.position().top,e=a.outerHeight();0>d?b+=d:d+e>c&&(b-=c-d-e),this.ui.playlist.prop("scrollTop",b)},setRemoveButton:function(){this.ui.remove.toggleClass("disabled",this.$(".selected").length<=0)},handleKeyboard:function(a){var b={13:this.play,35:function(a){return a.shiftKey?this.selectRange(this.$(".selected").last(),this.$(".playlist-item").last()):this.select(this.$(".playlist-item").last()),!1},36:function(a){return a.shiftKey?this.selectRange(this.$(".selected").last(),this.$(".playlist-item").first()):this.select(this.$(".playlist-item").first()),!1},38:this.selectPrev,40:this.selectNext,46:this.remove,65:function(a){return a.ctrlKey?(this.selectAll(),!1):void 0},68:function(a){return a.ctrlKey?(this.selectNone(),!1):void 0}},c=b[a.which];return c?c.call(this,a):void 0}})});return b});