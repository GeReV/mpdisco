/*! mpdisco 2014-06-22 */
define(["mpdisco","vendor/jquery.iframe-transport","vendor/jquery.fileupload","vendor/jquery.fileupload-validate"],function(a){var b=a.module("Library",function(a,b,c,d,e){a.Artist=b.Model.extend({defaults:{artist:"Artist"}}),a.ArtistCollection=b.Collection.extend({model:a.Artist,socketEvents:{"list:artist":"update"},update:function(a){this.reset(a.data)}}),a.Song=b.Model.extend({defaults:{song:"Song"}}),a.SongCollection=b.Collection.extend({model:a.Song,socketEvents:{find:"update"},update:function(a){var b=a.args.join(" ");b===this.filter&&(this.reset(a.data),this.socketOff("find"))}}),a.Album=b.Model.extend({defaults:{title:"Album",year:null}}),a.AlbumCollection=b.Collection.extend({model:a.Album,socketEvents:{"list:album":"update"},filter:null,update:function(a){var b=a.args[0];b===this.filter&&(this.reset(a.data),this.socketOff("list:album"))}}),a.LibrarySongView=d.ItemView.extend({tagName:"li",className:"library-item song",template:"song",events:{"mousedown > .name":"select","dblclick > .name":"add",dragstart:"dragstart"},ui:{name:".name"},onDomRefresh:function(){this.$el.attr("data-id",this.model.get("title")),this.$el.draggable({appendTo:".library",distance:2,scope:"media",helper:function(a){var b=e(a.currentTarget);return e("<div/>",{"class":b.attr("class")}).html(b.html()).eq(0)}})},select:function(){b.vent.trigger("select:library",this)},add:function(){return b.command("add",this.model.get("file")),!1},dragstart:function(a,b){b.helper.data("model",this.model.toJSON()),a.stopPropagation()}}),a.LibraryAlbumView=d.CompositeView.extend({tagName:"li",className:"library-item album",template:"album",events:{"click > .name":"toggleSongs","mousedown > .name":"select","dblclick > .name":"add",dragstart:"dragstart"},ui:{songs:".songs",name:".name"},itemView:a.LibrarySongView,itemViewContainer:".tree",initialize:function(){this.collection=new a.SongCollection},onDomRefresh:function(){this.$el.attr("data-id",this.model.get("album")),this.$el.draggable({appendTo:".library",distance:2,scope:"media",helper:function(a){var b=e(a.currentTarget);return e("<div/>",{"class":b.attr("class")}).html(b.html()).eq(0)}})},loaded:!1,toggleSongs:function(a){var c=e(a.currentTarget).toggleClass("open"),d=c.closest(".artist").find(".name"),f=c.data("id"),g=d.data("id");return this.ui.songs.toggleClass("collapsed"),this.loaded||(this.collection.filter=g+" "+f,b.command("find",["artist",g,"album",f]),this.loaded=!0),!1},select:function(){b.vent.trigger("select:library",this)},add:function(a){var c=e(a.currentTarget),d=c.closest(".artist").find(".name"),f=c.data("id"),g=d.data("id");return b.command("findadd",["artist",g,"album",f]),!1},dragstart:function(a,b){var c=this.model.get("album"),d=this.$el.closest(".artist").data("id");e(b.helper).data("model",{album:c,artist:d}),a.stopPropagation()}}),a.LibraryArtistView=d.CompositeView.extend({tagName:"li",className:"library-item artist",template:"artist",events:{"click > .name":"toggleAlbums","mousedown > .name":"select","dblclick > .name":"add",dragstart:"dragstart"},ui:{albums:".albums",name:".name"},itemView:a.LibraryAlbumView,itemViewContainer:".tree",initialize:function(){this.collection=new a.AlbumCollection},onDomRefresh:function(){this.$el.attr("data-id",this.model.get("artist")),this.$el.draggable({appendTo:".library",distance:2,scope:"media",helper:function(a){var b=e(a.currentTarget);return e("<div/>",{"class":b.attr("class")}).html(b.html()).eq(0)}})},loaded:!1,toggleAlbums:function(a){var c=e(a.currentTarget).toggleClass("open"),d=c.data("id");return this.ui.albums.toggleClass("collapsed"),this.loaded||(this.collection.filter=d,b.command("list",["album",d]),this.loaded=!0),!1},select:function(){b.vent.trigger("select:library",this)},add:function(a){var c=e(a.currentTarget),d=c.data("id");return b.command("findadd",["artist",d]),!1},dragstart:function(a,b){var c=this.model.get("artist");e(b.helper).data("model",{artist:c}),a.stopPropagation()}}),a.LibraryView=d.CompositeView.extend({template:"library",className:"library",collection:new a.ArtistCollection,itemView:a.LibraryArtistView,itemViewContainer:".tree",ui:{overlay:"#overlay",files:"#fileupload",library:".tree",upload:".upload"},events:{"drop #overlay":"drop","dragleave #overlay":"clearDrop","dragend #overlay":"clearDrop",fileuploadadd:"createProgress",fileuploadprocessstart:"startProgress",fileuploadprogress:"showProgress",fileuploaddone:"finishProgress",fileuploadfail:"failProgress"},initialize:function(){b.command("list","artist"),this.listenTo(b.vent,"select:library",this.select)},select:function(a){this.$("li").removeClass("selected"),a.$el.addClass("selected")},onShow:function(){var a=this;e(document).on("dragenter.library",function(){a.$el.addClass("library-drop")})},onClose:function(){e(document).off("dragover.library")},onRender:function(){this.ui.files.fileupload({autoUpload:!0,sequentialUploads:!0})},drop:function(){this.clearDrop()},clearDrop:function(){this.$el.removeClass("library-drop")},startProgress:function(){this.$el.addClass("uploading")},finishProgress:function(a,c){c.context.addClass("finished"),this.ui.upload.children().not(".finished").length||(this.ui.upload.empty(),this.$el.removeClass("library-drop uploading"),b.command("update"))},createProgress:function(a,b){b.files.length&&(b.context=e('<li><span class="filename">'+b.files[0].name+'</span><span class="progress-bar"><span class="progress"></span></span></li>').appendTo(this.ui.upload))},showProgress:function(a,b){var c=parseInt(b.loaded/b.total*100,10),d=b.context.position().top,e=b.context.height(),f=this.ui.upload.height();d>f&&this.ui.upload.prop("scrollTop",d+e-f),b.context.find(".progress").css("width",c+"%")},failProgress:function(a,b){b.context.addClass("failed")}})});return b});