/*! mpdisco 2014-06-22 */
!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","tmpl","./jquery.fileupload-image","./jquery.fileupload-audio","./jquery.fileupload-video","./jquery.fileupload-validate"],a):a(window.jQuery,window.tmpl)}(function($,a,b){"use strict";$.blueimp.fileupload.prototype._specialOptions.push("filesContainer","uploadTemplateId","downloadTemplateId"),$.widget("blueimp.fileupload",$.blueimp.fileupload,{options:{autoUpload:!1,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",getNumberOfFiles:function(){return this.filesContainer.children().length},getFilesFromResponse:function(a){return a.result&&$.isArray(a.result.files)?a.result.files:[]},add:function(a,b){var c=$(this),d=c.data("blueimp-fileupload")||c.data("fileupload"),e=d.options,f=b.files;b.process(function(){return c.fileupload("process",b)}).always(function(){b.context=d._renderUpload(f).data("data",b),d._renderPreviews(b),e.filesContainer[e.prependFiles?"prepend":"append"](b.context),d._forceReflow(b.context),d._transition(b.context).done(function(){d._trigger("added",a,b)===!1||!e.autoUpload&&!b.autoUpload||b.autoUpload===!1||b.files.error||b.submit()})})},send:function(a,b){var c=$(this).data("blueimp-fileupload")||$(this).data("fileupload");return b.context&&b.dataType&&"iframe"===b.dataType.substr(0,6)&&b.context.find(".progress").addClass(!$.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%"),c._trigger("sent",a,b)},done:function(a,b){var c=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),d=b.getFilesFromResponse||c.options.getFilesFromResponse,e=d(b),f,g;b.context?b.context.each(function(d){var g=e[d]||{error:"Empty file upload result"},h=c._addFinishedDeferreds();c._transition($(this)).done(function(){var d=$(this);f=c._renderDownload([g]).replaceAll(d),c._forceReflow(f),c._transition(f).done(function(){b.context=$(this),c._trigger("completed",a,b),c._trigger("finished",a,b),h.resolve()})})}):(f=c._renderDownload(e).appendTo(c.options.filesContainer),c._forceReflow(f),g=c._addFinishedDeferreds(),c._transition(f).done(function(){b.context=$(this),c._trigger("completed",a,b),c._trigger("finished",a,b),g.resolve()}))},fail:function(a,b){var c=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),d,e;b.context?b.context.each(function(f){if("abort"!==b.errorThrown){var g=b.files[f];g.error=g.error||b.errorThrown||!0,e=c._addFinishedDeferreds(),c._transition($(this)).done(function(){var f=$(this);d=c._renderDownload([g]).replaceAll(f),c._forceReflow(d),c._transition(d).done(function(){b.context=$(this),c._trigger("failed",a,b),c._trigger("finished",a,b),e.resolve()})})}else e=c._addFinishedDeferreds(),c._transition($(this)).done(function(){$(this).remove(),c._trigger("failed",a,b),c._trigger("finished",a,b),e.resolve()})}):"abort"!==b.errorThrown?(b.context=c._renderUpload(b.files).appendTo(c.options.filesContainer).data("data",b),c._forceReflow(b.context),e=c._addFinishedDeferreds(),c._transition(b.context).done(function(){b.context=$(this),c._trigger("failed",a,b),c._trigger("finished",a,b),e.resolve()})):(c._trigger("failed",a,b),c._trigger("finished",a,b),c._addFinishedDeferreds().resolve())},progress:function(a,b){if(b.context){var c=Math.floor(b.loaded/b.total*100);b.context.find(".progress").attr("aria-valuenow",c).find(".bar").css("width",c+"%")}},progressall:function(a,b){var c=$(this),d=Math.floor(b.loaded/b.total*100),e=c.find(".fileupload-progress"),f=e.find(".progress-extended");f.length&&f.html((c.data("blueimp-fileupload")||c.data("fileupload"))._renderExtendedProgress(b)),e.find(".progress").attr("aria-valuenow",d).find(".bar").css("width",d+"%")},start:function(a){var b=$(this).data("blueimp-fileupload")||$(this).data("fileupload");b._resetFinishedDeferreds(),b._transition($(this).find(".fileupload-progress")).done(function(){b._trigger("started",a)})},stop:function(a){var b=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),c=b._addFinishedDeferreds();$.when.apply($,b._getFinishedDeferreds()).done(function(){b._trigger("stopped",a)}),b._transition($(this).find(".fileupload-progress")).done(function(){$(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%"),$(this).find(".progress-extended").html("&nbsp;"),c.resolve()})},processstart:function(){$(this).addClass("fileupload-processing")},processstop:function(){$(this).removeClass("fileupload-processing")},destroy:function(a,b){var c=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),d=function(){c._transition(b.context).done(function(){$(this).remove(),c._trigger("destroyed",a,b)})};b.url?$.ajax(b).done(d):d()}},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(a){return a||(a=$.Deferred()),this._finishedUploads.push(a),a},_getFinishedDeferreds:function(){return this._finishedUploads},_enableDragToDesktop:function(){var a=$(this),b=a.prop("href"),c=a.prop("download"),d="application/octet-stream";a.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",[d,c,b].join(":"))}catch(e){}})},_formatFileSize:function(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" GB":a>=1e6?(a/1e6).toFixed(2)+" MB":(a/1e3).toFixed(2)+" KB"},_formatBitrate:function(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" Gbit/s":a>=1e6?(a/1e6).toFixed(2)+" Mbit/s":a>=1e3?(a/1e3).toFixed(2)+" kbit/s":a.toFixed(2)+" bit/s"},_formatTime:function(a){var b=new Date(1e3*a),c=Math.floor(a/86400);return c=c?c+"d ":"",c+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+":"+("0"+b.getUTCSeconds()).slice(-2)},_formatPercentage:function(a){return(100*a).toFixed(2)+" %"},_renderExtendedProgress:function(a){return this._formatBitrate(a.bitrate)+" | "+this._formatTime(8*(a.total-a.loaded)/a.bitrate)+" | "+this._formatPercentage(a.loaded/a.total)+" | "+this._formatFileSize(a.loaded)+" / "+this._formatFileSize(a.total)},_renderTemplate:function(a,b){if(!a)return $();var c=a({files:b,formatFileSize:this._formatFileSize,options:this.options});return c instanceof $?c:$(this.options.templatesContainer).html(c).children()},_renderPreviews:function(a){a.context.find(".preview").each(function(b,c){$(c).append(a.files[b].preview)})},_renderUpload:function(a){return this._renderTemplate(this.options.uploadTemplate,a)},_renderDownload:function(a){return this._renderTemplate(this.options.downloadTemplate,a).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(a){a.preventDefault();var b=$(a.currentTarget),c=b.closest(".template-upload"),d=c.data("data");d&&d.submit&&!d.jqXHR&&d.submit()&&b.prop("disabled",!0)},_cancelHandler:function(a){a.preventDefault();var b=$(a.currentTarget).closest(".template-upload"),c=b.data("data")||{};c.jqXHR?c.jqXHR.abort():(c.errorThrown="abort",this._trigger("fail",a,c))},_deleteHandler:function(a){a.preventDefault();var b=$(a.currentTarget);this._trigger("destroy",a,$.extend({context:b.closest(".template-download"),type:"DELETE"},b.data()))},_forceReflow:function(a){return $.support.transition&&a.length&&a[0].offsetWidth},_transition:function(a){var b=$.Deferred();return $.support.transition&&a.hasClass("fade")&&a.is(":visible")?a.bind($.support.transition.end,function(c){c.target===a[0]&&(a.unbind($.support.transition.end),b.resolveWith(a))}).toggleClass("in"):(a.toggleClass("in"),b.resolveWith(a)),b},_initButtonBarEventHandlers:function(){var a=this.element.find(".fileupload-buttonbar"),b=this.options.filesContainer;this._on(a.find(".start"),{click:function(a){a.preventDefault(),b.find(".start").click()}}),this._on(a.find(".cancel"),{click:function(a){a.preventDefault(),b.find(".cancel").click()}}),this._on(a.find(".delete"),{click:function(c){c.preventDefault(),b.find(".toggle:checked").closest(".template-download").find(".delete").click(),a.find(".toggle").prop("checked",!1)}}),this._on(a.find(".toggle"),{change:function(a){b.find(".toggle").prop("checked",$(a.currentTarget).is(":checked"))}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar").find(".start, .cancel, .delete"),"click"),this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_initEventHandlers:function(){this._super(),this._on(this.options.filesContainer,{"click .start":this._startHandler,"click .cancel":this._cancelHandler,"click .delete":this._deleteHandler}),this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers(),this._off(this.options.filesContainer,"click"),this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var b=this.options;b.templatesContainer=this.document[0].createElement(b.filesContainer.prop("nodeName")),a&&(b.uploadTemplateId&&(b.uploadTemplate=a(b.uploadTemplateId)),b.downloadTemplateId&&(b.downloadTemplate=a(b.downloadTemplateId)))},_initFilesContainer:function(){var a=this.options;void 0===a.filesContainer?a.filesContainer=this.element.find(".files"):a.filesContainer instanceof $||(a.filesContainer=$(a.filesContainer))},_initSpecialOptions:function(){this._super(),this._initFilesContainer(),this._initTemplates()},_create:function(){this._super(),this._resetFinishedDeferreds()},enable:function(){var a=!1;this.options.disabled&&(a=!0),this._super(),a&&(this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton())},disable:function(){this.options.disabled||(this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton()),this._super()}})});